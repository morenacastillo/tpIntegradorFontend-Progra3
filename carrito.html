<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- CDN para usar jsPDF -->
        <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
        <link rel="stylesheet" href="css/styles.css">
        <link rel="icon" type="image" href="img/favicon/cara-de-gato-sin-boca.png">
        <title>Duque's Music</title>
    </head>

    
    <body>
        <header>
            <div class="div-header-p-img">
                <img class="header-img" src="img/favicon/cara-de-gato-feliz.png" alt="">
                <p class="header-p">Duque's <span class="header-p-span">Music</span></p>
            </div>
            
            <nav>    
                <div class="nav-div">
                    <a class="nav-a" href="inicio.html">Inicio</a>
                    <a class="nav-a" href="productos.html">Productos</a>
                    <a class="nav-a" href="carrito.html">Carrito</a>
                </div>
            </nav>
        </header>    


        <main>
            <h1>Carrito</h1>
            <hr>
            <h3 id="contador-carrito">Carrito: 0 Productos</h3>
            <section id="contenedor-carrito"></section>
            <div id="notification-container"></div>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            
            <button id="imprimir-ticket">Imprimir ticket</button>
        </main>


        <footer>
            <p>Emiliano David Centurion - Morena Castillo</p>
        </footer>


        <script>
            let nombreUsuario = sessionStorage.getItem("nombreUsuario")
            if(!nombreUsuario) {
                window.location.href = "bienvenida.html"
            }

            carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];

            const imprimirTicket = document.getElementById("imprimir-ticket")

            let htmlCarrito = ""
            const contenedorCarrito = document.getElementById("contenedor-carrito");

            function mostrarCarrito() {
                htmlCarrito = "<ul>";
                let totalProductos = carrito.reduce((acum, prod) => acum + prod.cantidad, 0);

                carrito.forEach((prod, indice) => {
                    htmlCarrito += `
                    <li class="bloque-item">
                        <p class="nombre-item">${prod.titulo} - ${prod.tipo} - $${prod.precio}      x ${prod.cantidad}</p>
                        <button class="boton-eliminar" onclick="eliminarDelCarrito(${indice})">Eliminar</button>
                    `;
                });

                if (carrito.length >= 1) {
                    htmlCarrito += `
                        </ul>
                        <div class="carrito-footer">
                            <button id="vaciar-carrito" onclick="vaciarCarrito()">Vaciar carrito</button>
                            <p class="total-carrito">
                                Total: $${carrito.reduce((acum, prod) => acum + (prod.precio * prod.cantidad), 0)
                                .toFixed(2)}
                            </p>
                        </div>`;
                } else {
                    htmlCarrito += `
                    <br><br></ul>
                    <p class="carrito-vacio">El carrito se encuentra vacío...</p>
                    <br>
                    <img class="carrito-img" src="img/favicon/cara-de-gato-triste.png" alt="">`;
                }

                contenedorCarrito.innerHTML = htmlCarrito;

                document.getElementById("contador-carrito").textContent =
                `Carrito: ${totalProductos} productos`;

                const botonImprimir = document.getElementById("imprimir-ticket");

                if (carrito.length > 0) {
                    botonImprimir.style.display = "block";
                } else {
                    botonImprimir.style.display = "none";
                }
            }
            
            function eliminarDelCarrito(indice){
                const prod = carrito[indice];
                if(prod.cantidad > 1){
                    prod.cantidad--;
                } else{
                    carrito.splice(indice, 1);
                }
                mostrarCarrito();
                actualizarCarrito();
                mostrarNotificacion("Producto eliminado del carrito con exito");

            }
            
            function vaciarCarrito(){
                carrito = []
                mostrarCarrito()
                actualizarCarrito()
            }

            function actualizarCarrito(){
                sessionStorage.setItem("carrito", JSON.stringify(carrito));
            }

            function mostrarNotificacion(mensaje) {
                    const contenedor = document.getElementById("notification-container");

                    if (!contenedor) {
                        console.error("No existe el contenedor de notificaciones");
                        return;
                    }

                    const notificacion = document.createElement("div");
                    notificacion.classList.add("notification");
                    notificacion.textContent = mensaje;

                    contenedor.appendChild(notificacion);

                    setTimeout(() => notificacion.remove(), 3000);
                }
            
            // Imprimir tickets pdf

            imprimirTicket.addEventListener("click", imprimirTicketCarrito)

            function imprimirTicketCarrito() {
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let y = 10;

                doc.setFont("Helvetica", "bold");
                doc.setFontSize(18);
                doc.text("Duque's Music", 10, y);

                y += 7;

                doc.setFontSize(12);
                doc.setFont("Helvetica", "normal");
                doc.text("Ticket de compra", 10, y);

                y += 6;

                const ahora = new Date()

                const fecha = ahora.toLocaleDateString("es-AR");
                const hora = ahora.toLocaleTimeString("es-AR", {hour: "2-digit", minute: "2-digit"})
                doc.text(`Fecha: ${fecha}`, 10, y);
                
                y += 6;

                doc.text(`Hora: ${hora}`, 10, y);

                y += 5;

                // Línea separadora
                doc.line(10, y, 200, y);
                
                y += 10;

                doc.setFont("Helvetica", "bold");
                doc.text("Producto", 10, y);
                doc.text("Tipo", 80, y)
                doc.text("Cant.", 110, y);
                doc.text("Precio", 150, y);

                y += 6;

                doc.line(10, y, 200, y); 
                
                y += 8;

                doc.setFont("Helvetica", "normal");

                carrito.forEach((prod) => {
                    doc.text(prod.titulo.substring(0, 30), 10, y);
                    doc.text(`${prod.tipo}`, 80, y);
                    doc.text(String(prod.cantidad), 115, y);
                    doc.text(`$${(prod.precio * prod.cantidad).toFixed(2)}`, 150, y);
                    y += 8;
                });

                y += 4;

                doc.line(10, y, 200, y);
                
                y += 10;

                const precioTotal = carrito.reduce(
                    (total, prod) => total + prod.precio * prod.cantidad, 
                    0
                ).toFixed(2);

                doc.setFont("Helvetica", "bold");
                doc.setFontSize(14);
                doc.text(`TOTAL: $${precioTotal}`, 10, y);

                y += 15;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(12);
                doc.text("¡Gracias por tu compra!", 10, y);

                doc.save("ticket.pdf");
            }

            function init(){
                mostrarCarrito();
            }

            init()
        </script>
    </body>
</html>